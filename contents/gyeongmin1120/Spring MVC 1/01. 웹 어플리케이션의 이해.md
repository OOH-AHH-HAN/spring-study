# 웹 어플리케이션의 이해

## 웹 서버, 웹 애플리케이션 서버

웹은 HTTP 위에서 동작한다.   
클라이언트(웹브라우저)가 인터넷에 요청을 보내면 다시 서버로 요청을 보내고 그 서버가 HTML 등 리소스를 보내주는 방식.    
HTTP 메시지에 모든 것을 전송한다.(거의 모든 형태의 데이터)

<br/>

### 웹 서버(Web Server)
- HTTP 기반으로 동작
- 정적 리소스 제공, 기타 부가 기능
	+ 정적 파일(HTML, CSS, JS, 이미지 영상)
- NGINX, APACHE

<br/>

### 웹 애플리케이션 서버(WAS - Web Application Server)
- HTTP 기반으로 동작
- 웹서버 기능 + 애플리케이션 로직 수행
	+ 동적 HTML, HTTP API(JSON)
	+ 서블릿, JSP, 스프링 MVC
- Tomcat, Jetty, Undertow
- 애플리케이션 코드를 실행하는데 더 특화

> 자바는 서블릿 컨테이너 기능을 제공하면 WAS

<br/>

### 웹 시스템 구성 - WAS, DB
- WAS, DB만으로 시스템 구성 가능
- 문제점
	+ WAS가 너무 많은 역할을 담당
	+ 서버 과부하 우려
	+ 가장 비싼 애플리케이션(비즈니스 로직. 주문 등등) 로직이 정적 리소스때문에 수행이 어려울 수 있음
	+ 오류 화면 노출 불가능

<br/>

### 웹 시스템 구성 - WEB, WAS, DB
- 정적 리소스는 웹 서버
- WAS가 중요한 애플리케이션 로직 처리 담당
- 정적 리소스가 많이 사용되면 Web 서버 증설
- 애플리케이션 리소스가 많이 사용되면 WAS 증설
- 데이터 API로 데이터만 제공할 때는 Web Server 없어도 됨

<br/>
<br/>

## 서블릿

HTML 폼 데이터를 전송하게 되면 서버에서 처리하는 업무들이 있다.    
그 중에 서버 연결, HTTP 요청 메세지 파싱, 소켓 종료 등과 같이 공통적이고 개개인의 개발자가 개발하기엔 너무 많으며 비효율적인 것들을 서블릿이 지원해준다.    
서블릿을 지원하는 WAS를 사용하게 된다면 의미있는 비즈니스 로직만 개발하면 된다.

<br/>

### 특징
- urlPatterns(/hello)의 URL이 호출되면 서블릿 코드가 실행
- HttpServletRequest : HTTP 요청 정보 편리하게 사용(꺼내서 쓰면 됨)
- HttpServletResponse : HTTP 응답 정보 편리하게 사용(원하는 데이터 넣으면 됨)
- 개발자는 HTTP 스펙을 매우 편리하게 사용 -> 기본 스펙을 알아야 쓸 수 있음

<br/>

### 동작 원리

웹 브라우저가 `localhost:8080/hello`라고 요청을 보내면 웹 애플리케이션 서버에서 HTTP 요청 메시지를 기반으로 Request 객체를 새로 생성한다.   
response 객체도 새로 생성한다.   
request객체와 response 객체를 서블릿 컨테이너로 보낸다.   
request 객체에서 HTTP 요청 정보를 꺼내서 편리하게 사용하고 response 객체에 HTTP 응답 정보를 편리하게 입력한다.   
종료가 되면 response 객체 정보로 HTTP 응답을 생성한다.   
HTTP 응답을 웹 브라우저로 보낸다.

<br/>

### 서블릿 컨테이너
- 서블릿 컨테이너 : 톰캣처럼 서블릿을 지원하는 WAS
- 서블릿 컨테이너는 name 값에 따라서 서블릿을 객체를 생성, 호출, 관리한다.
	+ 생성, 초기화, 호출, 종료하는 생명주기 관리
- 서블릿 객체는 싱글톤으로 관리
	+ 공유 변수 사용 주의
	+ 서블릿 컨테이너 종료시 함께 종료
	+ request, response는 항상 새로 생성. 하지만 helloServlet은 항상 생성할 필요 없음
- JSP도 서블릿으로 변환되어서 사용
- 동시 요청을 위한 멀티쓰레드 처리 지원

<br/>
<br/>

## :star: 동시 요청 - 멀티 쓰레드

웹 브라우저에서 요청을 하면 WAS의 쓰레드가 서블릿 객체를 호출한다.

### 쓰레드
- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것
- 자바 main 메소드 실행 -> main이라는 쓰레드 실행
- 한번에 하나의 코드 라인만 수행
- 동시 처리가 필요하면 쓰레드 추가 생성
- 단일 요청
	+ 요청이 오면 쓰레드가 할당되어 응답
- 다중 요청
	+ 쓰레드 하나 사용
		* 여러개의 요청이 오면 뒤에 온 요청들이 쓰레드 대기 상태
	+ 요청마다 쓰레드 생성
		* 장점
			- 동시 요청 처리 가능
			- 리소스(CPU, 메모리) 허용할 때 까지 처리 가능
			- 다른 쓰레드에 영향 없음
		* 단점
			- 비용 매우 비쌈
			- 응답 속도 느려짐
			- 컨텍스트 스위칭 비용 발생
				+ 쓰레드 1에서 2로 전환할 때 발생
			- 리소스 허용치를 넘으면 서버 죽을 수 있음

	+ 쓰레드 풀(보통 WAS)
		- 쓰레드풀에 일정 개수의 쓰레드 생성해놓고 요청이 오면 빌려쓰고 다 쓰면 반납
		- 일정 개수 넘어가면 쓰레드 대기 혹은 거절
		- 톰캣을 최대 200개 설정 가능(변경 가능)
		- 비용(CPU) 절약
		- 응답시간 빠름
		- 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리 가능
		- 적정 숫자
			+ 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다름

- WAS의 주요 튜닝포인트는 최대 쓰레드 수 -> 극적인 효과 볼 가능성이 많음
	+ 장에 발생 시 클라우드면 일단 서버부터 늘리고 이후에 튜닝, 클라우드가 아니면 열심히 튜닝
- WAS의 멀티 쓰레드 지원
	+ WAS가 처리(개발자는 신경 안써도 됨 - 싱글 쓰레드 개발하듯이 하기)
	+ 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용 - 공유변수

<br/>
<br/>

## HTML, HTTP API, CSR, SSR

1. 정적 리소스
	- 고정된 HTML, CSS, JS, 이미지, 영상 등 제공
	- 주로 웹 브라우저에서 요청
2. HTML 페이지
	- 동적으로 필요한 HTML을 생성해서 전달.
3. HTTP API
	- 페이지가 아니라 데이터를 전달
	- 주로 JSON 형식
	- 앱, 웹 클라이언트, 서버 to 서버

### CSR, SSR
- SSR(서버 사이드 렌더링)
	+ HTML 최종 결과를 서버에서 만들어서 웹 브라우저에 전달
	+ 주로 정적인 화면
	+ JSP, 타임 리프
- CSR(클라이언트 사이드 렌더링)
	+ HTML 코드를 자바스크립트를 사용해 웹 브라우저에서 동적으로 생성해서 적용
	+ 동적인 화면에 사용, 웹 환경을 부분부분 변경 가능
	+ 구글 지도, 캘린더 등
	+ React, Vue.js
	+ 클라이언트가 서버에 HTML을 요청하면 HTML에 내용 없이 JS 링크만 내려주고 클라이언트에서 다시 JS 요청을 하면 그때 HTML 로직을 내려줌
- SSR을 사용하더라도 JS를 사용해서 화면 일부를 동적으로 변경 가능

<br/>
<br/>

## 자바 백엔드 웹 기술 역사

1. 서블릿 : HTML 생성이 어려움
2. JSP : HTML 생성은 편리하지만 비즈니스 로직까지 너무 많은 역할 담당
3. 서블릿, JSP 조합 MVC 패턴 사용 : 모델, 뷰, 컨트롤러로 역할을 나누어 개발
4. MVC 춘추전국시대 : 패턴 자동화, 다양한 기능 지원. 스트럿츠, 웹 워크, 스프링 MVC(과거 버전)
5. 현재의 스프링 MVC : 애노테이션 기반. 스프링 부트 등장
	- 스프링 부트
		+ 스프링을 편리하게 사용하게 해주는 것
		+ 서버를 내장
		+ 과거에는 서버에 WAS를 직접 설치하고(Tomcat), 소스는 jar를 모아서 War를 만들어서 설치한 WAS에 배포
		+ 스프링 부트는 빌드 결과(jar)에 WAS 서버 포함 -> 빌드 배포 단순화
	- 스프링 웹 플럭스
		+ 비동기 넌 블로킹 처리
		+ 최소 쓰레드로 최대 성능 - 쓰레드 컨텍스트 스위칭 비용 효율화 -> 쓰레드를 코어에 맞춰서 사용
		+ 기술적 난이도 높음
		+ 실무에서 아직 많이 사용하지 않음
	- 뷰 템플릿
		+ JSP : 속도 느림
		+ 프리마터, 벨로시티 : 성능은 가장 빠름
		+ 타임리프 : 최선의 선택


