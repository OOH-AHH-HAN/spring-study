# 10. 스프링 타입 컨버터

## 프로젝트 생성

- Project: Gradle Project
- Spring Boot: 2.7.11
- Group: hello
- Artifact: typeconverter
- Name: typeconverter
- Package name: hello.typeconverter
- Packaging: Jar
- Java: 11

<br/>
<br/>

## 스프링 타입 컨버터 소개

- 문자를 숫자로 변환하거나 숫자를 문자로 변환하는 등 타입을 변환할 때 사용되는 것

<br/>

`java/hello/typeconverter/controller/HelloController.java`

```java
package hello.typeconverter.controller;

import hello.typeconverter.type.IpPort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
public class HelloController {

    @GetMapping("/hello-v1")
    public String helloV1(HttpServletRequest request) {
        String data = request.getParameter("data"); //문자 타입 조회
        //변환하는 과정 필요
        Integer intValue = Integer.valueOf(data); //숫자 타입으로 변경
        System.out.println("intValue = " + intValue); 
        return "ok";
    }

		@GetMapping("/hello-v2")
    //@RequestParam을 사용했을 때 스프링이 중간에서 타입을 바꿔줌
    public String helloV2(@RequestParam Integer data) {
        System.out.println("data = " + data);
        return "ok";
    }
}
```

- 스프링의 타입 변환 적용 예
    - 스프링 MVC 요청 파라미터
        - @RequestParam , @ModelAttribute , @PathVariable
    - @Value 등으로 YML 정보 읽기
    - XML에 넣은 스프링 빈 정보를 변환
    - 뷰를 렌더링 할 때
- 개발자가 새로운 타입을 만들어서 변환하고 싶으면?
    - 스프링이 제공하는 확장 가능한 컨버터 인터페이스를 구현해서 등록하면 됨
    - 컨버터 인터페이스는 모든 타입에 적용 가능
- 과거에는 PropertyEditor라는 것으로 타입 변환을 했으나 동시성 문제가 있어 객체를 계속 생성해야 하는 단점 발생 → Converter를 사용

<br/>
<br/>

## 타입 컨버터 - Converter

- org.springframework.core.convert.converter.Converter 구현 → Converter  인터페이스 많으니 조심해야 함
- 문자를 숫자로 변환하는 타입 컨버터
    
    `java/hello/typeconverter/converter/StringToIntegerConverter.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.core.convert.converter.Converter;
    
    @Slf4j
    public class StringToIntegerConverter implements Converter<String, Integer> {
        @Override
        public Integer convert(String source) {
            log.info("convert source={}", source);
            return Integer.valueOf(source);
        }
    }
    ```
    
- 숫자를 문자로 변환하는 타입 컨버터
    
    `java/hello/typeconverter/converter/IntegerToStringConverter.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.core.convert.converter.Converter;
    
    @Slf4j
    public class IntegerToStringConverter implements Converter<Integer, String> {
    
        @Override
        public String convert(Integer source) {
            log.info("convert source={}", source);
            return String.valueOf(source);
        }
    
    }
    ```
    

- 테스트 코드
    
    `java/hello/typeconverter/converter/ConverterTest.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import hello.typeconverter.type.IpPort;
    import org.junit.jupiter.api.Test;
    
    import static org.assertj.core.api.Assertions.assertThat;
    
    class ConverterTest {
        @Test
        void stringToInteger() {
            StringToIntegerConverter converter = new StringToIntegerConverter();
            Integer result = converter.convert("10");
            assertThat(result).isEqualTo(10);
        }
    
        @Test
        void integerToString() {
            IntegerToStringConverter converter = new IntegerToStringConverter();
            String result = converter.convert(10);
            assertThat(result).isEqualTo("10");
        }
    }ㅇ
    ```
    
<br/>


### 사용자 정의 타입 컨버터

- Ip, Port를 입력하면 IpPort 객체로 변환하는 컨버터
    
    `java/hello/typeconverter/type/IpPort.java`
    
    ```java
    package hello.typeconverter.type;
    
    import lombok.EqualsAndHashCode;
    import lombok.Getter;
    
    @Getter
    //모든 필드를 사용해서 equals() , hashcode() 를 생성
    @EqualsAndHashCode
    public class IpPort {
    
        private String ip;
        private int port;
    
        public IpPort(String ip, int port) {
            this.ip = ip;
            this.port = port;
        }
    }
    ```

	<br/>

    
    `java/hello/typeconverter/converter/StringToIpPortConverter.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import hello.typeconverter.type.IpPort;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.core.convert.converter.Converter;
    
    @Slf4j
    public class StringToIpPortConverter implements Converter<String, IpPort> {
    
        @Override
        public IpPort convert(String source) {
            log.info("convert source={}", source);
            //"127.0.0.1:8080" -> IpPort 객체
            String[] split = source.split(":");
            //127.0.0.1
            String ip = split[0];
            //8080
            int port = Integer.parseInt(split[1]);
    
            return new IpPort(ip, port);
        }
    }
    ```
    
	<br/>

    `java/hello/typeconverter/converter/IpPortToStringConverter.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import hello.typeconverter.type.IpPort;
    import lombok.extern.slf4j.Slf4j;
    import org.springframework.core.convert.converter.Converter;
    
    @Slf4j
    public class IpPortToStringConverter implements Converter<IpPort, String> {
        @Override
        public String convert(IpPort source) {
            log.info("convert source={}", source);
            //IpPort 객체 -> "127.0.0.1:8080"
            return source.getIp() + ":" + source.getPort();
        }
    }
    ```

	<br/>

    
    `java/hello/typeconverter/converter/ConverterTest.java`
    
    ```java
    package hello.typeconverter.converter;
    
    import hello.typeconverter.type.IpPort;
    import org.junit.jupiter.api.Test;
    
    import static org.assertj.core.api.Assertions.assertThat;
    
    class ConverterTest {
    
        ...
    
        @Test
        void stringToIpPort() {
            StringToIpPortConverter converter = new StringToIpPortConverter();
            String source = "127.0.0.1:8080";
            IpPort result = converter.convert(source);
            //객체에  @EqualsAndHashCode를 적어놔서 equals() 등등 다 구현되어 있음
            //참조값 달라도 비교 가능하므로 isEqualTo 사용 가능
            assertThat(result).isEqualTo(new IpPort("127.0.0.1", 8080));
        }
    
        @Test
        void ipPortToString() {
            IpPortToStringConverter converter = new IpPortToStringConverter();
            IpPort source = new IpPort("127.0.0.1", 8080);
            String result = converter.convert(source);
            assertThat(result).isEqualTo("127.0.0.1:8080");
        }
    }
    ```
    
 > 타입 컨버터를 하나하나 직접 사용하면 개발자가 직접 컨버팅하는 것과 큰 차이 없음.   
   타입 컨버터를 등록하고 관리하면서 편리하게 변환 기능을 제공하는 역할을 하는 무언가가 필요.
    
    
<br/>
<br/>

## 컨버전 서비스 - ConversionService

- 스프링이 개별 컨버터를 모아두고 그것들을 묶어서 편리하게 사용할 수 있는 기능을 제공해주는 것
- 컨버전 서비스 인터페이스는 단순히 컨버팅이 가능한지 확인하는 기능과 컨버팅 기능을 제공

<br/>

`java/hello/typeconverter/converter/ConversionServiceTest.java`

```java
package hello.typeconverter.converter;

import hello.typeconverter.type.IpPort;
import org.junit.jupiter.api.Test;
import org.springframework.core.convert.support.DefaultConversionService;

import static org.assertj.core.api.Assertions.assertThat;

public class ConversionServiceTest {
    @Test
    void conversionService() {
        //등록
				//DefaultConversionService : ConversionService 인터페이스를 구현
				//컨버터를 등록하는 기능도 제공
        DefaultConversionService conversionService = new DefaultConversionService();
        conversionService.addConverter(new StringToIntegerConverter());
        conversionService.addConverter(new IntegerToStringConverter());
        conversionService.addConverter(new StringToIpPortConverter());
        conversionService.addConverter(new IpPortToStringConverter());

        //사용
        assertThat(conversionService.convert("10", Integer.class)).isEqualTo(10);
        assertThat(conversionService.convert(10, String.class)).isEqualTo("10");

        IpPort ipPort = conversionService.convert("127.0.0.1:8080", IpPort.class);
        assertThat(ipPort).isEqualTo(new IpPort("127.0.0.1", 8080));

        String ipPortString = conversionService.convert(new IpPort("127.0.0.1", 8080), String.class);
        assertThat(ipPortString).isEqualTo("127.0.0.1:8080");
    }
}
```

<br/>

### 등록과 사용 분리

- 등록할 때는 타입 컨버터를 정확히 알아야 하지만 사용하는 입장에서는 몰라도 됨
- 타입 컨버터들은 모두 컨버전 서비스 내부에 숨어서 제공됨 → 타입 변환을 원하는 사용자는 컨버전 서비스 인터페이스에만 의존하면 됨
- 등록 부분과 사용 부분을 분리하고 의존관계 주입 사용

<br/>

### ISP(Interface Segregation Principle) - 인터페이스 분리 원칙

- 클라이언트가 자신이 이용하지 않는 메서드에 의존하지 않아야 함
- DefaultConversionService이 구현한 인터페이스
    - ConversionService : 컨버터 사용에 초점
    - ConverterRegistry : 컨버터 등록에 초점
- 인터페이스를 분리하면 컨버터를 사용하는 클라이언트와 컨버터를 등록하고 관리하는 클라이언트의 관심사를 명확하게 분리 가능

<br/>
<br/>

## 스프링에 Converter 적용하기

`java/hello/typeconverter/WebConfig.java`

```java
package hello.typeconverter;

import hello.typeconverter.converter.IntegerToStringConverter;
import hello.typeconverter.converter.IpPortToStringConverter;
import hello.typeconverter.converter.StringToIntegerConverter;
import hello.typeconverter.converter.StringToIpPortConverter;
import org.springframework.context.annotation.Configuration;
import org.springframework.format.FormatterRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addFormatters(FormatterRegistry registry) {
        registry.addConverter(new StringToIntegerConverter());
        registry.addConverter(new IntegerToStringConverter());
        registry.addConverter(new StringToIpPortConverter());
        registry.addConverter(new IpPortToStringConverter());
    }
}
```
<br/>

`java/hello/typeconverter/controller/HelloController.java`

```java
package hello.typeconverter.controller;

import hello.typeconverter.type.IpPort;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
public class HelloController {

    @GetMapping("/hello-v1")
    public String helloV1(HttpServletRequest request) {
        String data = request.getParameter("data"); //문자 타입 조회
        //변환하는 과정 필요
        Integer intValue = Integer.valueOf(data); //숫자 타입으로 변경
        System.out.println("intValue = " + intValue); 
        return "ok";
    }

    @GetMapping("/hello-v2")
    //@RequestParam을 사용했을 때 스프링이 중간에서 타입을 바꿔줌
    public String helloV2(@RequestParam Integer data) {
        System.out.println("data = " + data);
        return "ok";
    }

    @GetMapping("/ip-port")
    public String ipPort(@RequestParam IpPort ipPort) {
        System.out.println("ipPort IP = " + ipPort.getIp());
        System.out.println("ipPort PORT = " + ipPort.getPort());
        return "ok";
    }
}
```

- `StringToIntegerConverter`를 등록하기 전에도 이 코드는 잘 수행되었음 → 스프링이 내부에서 수 많은 기본 컨버터들을 제공
- 컨버터를 추가하면 추가한 컨버터가 기본 컨버터보다 높은 우선순위를 가짐
- `@RequestParam, @ModelAttribute, @PathVariable` 다 동작
- `@RequestParam`은 `@RequestParam`을 처리하는 `ArgumentResolver`인 `RequestParamMethodArgumentResolver`에서 `ConversionService`를 사용해서 타입을 변환